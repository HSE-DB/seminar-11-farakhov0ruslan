
## Задание 3

1. Создайте таблицу с большим количеством данных:
    ```sql
    CREATE TABLE test_cluster AS 
    SELECT 
        generate_series(1,1000000) as id,
        CASE WHEN random() < 0.5 THEN 'A' ELSE 'B' END as category,
        md5(random()::text) as data;
    ```

2. Создайте индекс:
    ```sql
    CREATE INDEX test_cluster_cat_idx ON test_cluster(category);
    ```

3. Измерьте производительность до кластеризации:
    ```sql
    EXPLAIN ANALYZE
    SELECT * FROM test_cluster WHERE category = 'A';
    ```

    *План выполнения:*
    ```
    Bitmap Heap Scan on test_cluster  (cost=5625.27..20313.86 rows=504367 width=39) (actual time=34.005..356.014 rows=500709 loops=1)
      Recheck Cond: (category = 'A'::text)
      Heap Blocks: exact=8334
      ->  Bitmap Index Scan on test_cluster_cat_idx  (cost=0.00..5499.18 rows=504367 width=0) (actual time=32.339..32.346 rows=500709 loops=1)
            Index Cond: (category = 'A'::text)
    Planning Time: 1.649 ms
    Execution Time: 374.996 ms
    ```

    *Объясните результат:*
    До кластеризации PostgreSQL использует Bitmap Heap Scan. Запрос обработал 8334 блока данных и вернул 500709 строк. Время выполнения составило 374.996 ms. Данные с category='A' разбросаны по всей таблице, что требует чтения большого количества блоков.

4. Выполните кластеризацию:
    ```sql
    CLUSTER test_cluster USING test_cluster_cat_idx;
    ```

    *Результат:*
    ```
    CLUSTER
    ```
    Кластеризация выполнена успешно. Таблица была физически переупорядочена в соответствии с индексом test_cluster_cat_idx.

5. Измерьте производительность после кластеризации:
    ```sql
    EXPLAIN ANALYZE
    SELECT * FROM test_cluster WHERE category = 'A';
    ```

    *План выполнения:*
    ```
    Bitmap Heap Scan on test_cluster  (cost=5625.27..20263.86 rows=504367 width=39) (actual time=21.572..175.126 rows=500709 loops=1)
      Recheck Cond: (category = 'A'::text)
      Heap Blocks: exact=4173
      ->  Bitmap Index Scan on test_cluster_cat_idx  (cost=0.00..5499.18 rows=504367 width=0) (actual time=20.889..20.889 rows=500709 loops=1)
            Index Cond: (category = 'A'::text)
    Planning Time: 2.285 ms
    Execution Time: 193.203 ms
    ```

    *Объясните результат:*
    После кластеризации PostgreSQL всё ещё использует Bitmap Heap Scan, но производительность значительно улучшилась. Количество обработанных блоков сократилось с 8334 до 4173 (в 2 раза). Время выполнения улучшилось с 374.996 ms до 193.203 ms (почти в 2 раза быстрее). Это происходит потому, что все строки с category='A' теперь расположены последовательно, что уменьшает количество операций ввода-вывода.

6. Сравните производительность до и после кластеризации:

    *Сравнение:*

    | Метрика | До кластеризации | После кластеризации | Улучшение |
    |---------|------------------|---------------------|-----------|
    | Execution Time | 374.996 ms | 193.203 ms | **1.94x быстрее** |
    | Heap Blocks | 8334 | 4173 | **2.0x меньше** |
    | Planning Time | 1.649 ms | 2.285 ms | Незначительно хуже |

    **Выводы:**

    1. **Производительность запросов улучшилась почти в 2 раза** (374.996 ms → 193.203 ms)

    2. **Количество обрабатываемых блоков сократилось в 2 раза** (8334 → 4173):
       - Кластеризация физически группирует строки с одинаковым значением category
       - Это уменьшает фрагментацию данных и количество операций ввода-вывода
       - Меньше блоков = меньше обращений к диску = быстрее выполнение

    3. **Основные преимущества кластеризации:**
       - Значительное улучшение производительности для range-запросов
       - Уменьшение количества random I/O операций
       - Улучшение использования кэша благодаря локальности данных
       - Особенно эффективна для запросов, возвращающих большие наборы данных

    4. **Важные замечания:**
       - Кластеризация - это одноразовая операция, требует периодического повторения
       - При вставках/обновлениях данные могут снова стать фрагментированными
       - Наиболее эффективна для таблиц, которые в основном читаются, а не изменяются
       - Требует блокировки таблицы на время выполнения операции CLUSTER